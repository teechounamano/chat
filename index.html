<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Te Echo Una Mano - Negociaciones Seguras</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2E86AB;
            --primary-dark: #1A5A7A;
            --secondary: #A23B72;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --light: #F8F9FA;
            --dark: #343A40;
            --gray: #6C757D;
            --border: #E9ECEF;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            max-height: 900px;
        }

        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid var(--primary-dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: var(--dark);
        }

        .status-activa { background-color: var(--success); color: white; }
        .status-completada { background-color: var(--primary); color: white; }
        .status-cancelada { background-color: var(--danger); color: white; }
        .status-expirada { background-color: var(--gray); color: white; }

        .chat-area {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Para que los nuevos mensajes aparezcan abajo */
        }

        .message {
            max-width: 80%;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-cliente {
            background-color: var(--secondary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .message-creador {
            background-color: var(--light);
            color: var(--dark);
            align-self: flex-start;
            border: 1px solid var(--border);
            border-bottom-left-radius: 0;
        }

        .message-system {
            background-color: var(--warning);
            color: var(--dark);
            text-align: center;
            align-self: center;
            max-width: 100%;
            font-style: italic;
            font-size: 0.85rem;
        }

        .message-time {
            display: block;
            margin-top: 5px;
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: right;
        }

        .input-area {
            padding: 10px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--light);
            position: sticky;
            bottom: 0;
        }

        .chat-input {
            display: flex;
            gap: 5px;
        }

        .input-area textarea {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            max-height: 100px;
        }

        .input-area button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }

        .input-area button:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .input-area button:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 5px 0;
        }

        .controls button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 0.9rem;
        }
        
        .controls button.btn-success { background-color: var(--success); }
        .controls button.btn-danger { background-color: var(--danger); }
        .controls button.btn-warning { background-color: var(--warning); color: var(--dark); }

        .controls button:hover { opacity: 0.8; }

        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            animation: fadein 0.3s forwards, fadeout 0.3s 2.7s forwards;
        }

        @keyframes fadein {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeout {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .timer {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--warning);
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <div class="container hidden" id="mainContainer">
        <div class="header">
            <h1>Negociación #<span id="negociacionId"></span></h1>
            <p>Monto: <strong id="negociacionMonto"></strong></p>
            <div class="status-info">
                <span>Estado: <span id="statusBadge" class="status-badge"></span></span>
                <span id="timerDisplay" class="timer">--:--:--</span>
            </div>
            <button onclick="copiarEnlace(window.location.href)" style="margin-top: 10px; background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem;">Copiar Enlace</button>
        </div>

        <div class="chat-area" id="chatArea">
            </div>

        <div class="input-area">
            <div id="clienteControls" class="controls hidden">
                <button class="btn-success" onclick="subirComprobanteHandler()">Subir Comprobante</button>
                <button class="btn-danger" onclick="cancelarNegociacionHandler()">Cancelar Negociación</button>
            </div>
            
            <div id="creadorControls" class="controls hidden">
                <button class="btn-success" onclick="verificarPagoHandler()">Verificar y Finalizar</button>
                <button class="btn-danger" onclick="cancelarNegociacionHandler()">Cancelar Negociación</button>
            </div>

            <div id="uploadSection" class="controls hidden">
                <input type="file" id="comprobanteFile" accept="image/*,.pdf" style="display:none;">
                <button class="btn-warning" onclick="document.getElementById('comprobanteFile').click()">Seleccionar Archivo</button>
                <button class="btn-success" id="btnConfirmUpload" disabled onclick="confirmarSubida()">Subir</button>
            </div>

            <div class="chat-input">
                <textarea id="messageInput" placeholder="Escribe tu mensaje..." rows="1" disabled></textarea>
                <button id="sendButton" onclick="enviarMensaje()" disabled>Enviar</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyI7G4KvdUz3GtIfWLapmWZstDe-61Q0OXNj0E/exec'; // Reemplaza con tu URL de Apps Script

        const appState = {
            idNegociacion: '',
            userType: '', // 'creador' o 'cliente'
            negociacion: null,
            intervaloMensajes: null,
            intervaloTimer: null
        };

        // =========================================================
        // FUNCIONES DE CONTROL DE INTERFAZ (FALTANTES - CORRECCIÓN)
        // =========================================================
        function habilitarChat() {
            document.getElementById('messageInput').disabled = false;
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = document.getElementById('messageInput').value.trim() === '';
            
            const estado = appState.negociacion?.Estado.toUpperCase().trim();
            const esCreador = appState.userType === 'creador';
            
            // Mostrar controles según el usuario y el estado
            if (estado === 'ACTIVA') {
                if (esCreador) {
                    document.getElementById('creadorControls').classList.remove('hidden');
                    document.getElementById('clienteControls').classList.add('hidden');
                } else {
                    document.getElementById('clienteControls').classList.remove('hidden');
                    document.getElementById('creadorControls').classList.add('hidden');
                }
                document.getElementById('uploadSection').classList.add('hidden'); // Ocultar por defecto, se muestra en subirComprobanteHandler
            }
        }

        function deshabilitarChat() {
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('clienteControls').classList.add('hidden');
            document.getElementById('creadorControls').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            if (appState.intervaloMensajes) clearInterval(appState.intervaloMensajes);
            if (appState.intervaloTimer) clearInterval(appState.intervaloTimer);
        }
        // =========================================================
        
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function init() {
            appState.idNegociacion = getQueryParam('id');
            appState.userType = getQueryParam('user') || 'cliente'; // Asume cliente por defecto
            
            if (!appState.idNegociacion) {
                mostrarNotificacion('Error: ID de negociación no encontrado.', 'danger');
                document.getElementById('loadingOverlay').classList.add('hidden');
                return;
            }

            document.getElementById('negociacionId').textContent = appState.idNegociacion;

            cargarDatosIniciales();
            
            // Iniciar el polling para mensajes si la negociación está ACTIVA
            if (!appState.intervaloMensajes) {
                appState.intervaloMensajes = setInterval(cargarMensajes, 5000); // Cada 5 segundos
            }
        }

        async function cargarDatosIniciales() {
            await cargarNegociacion();
            await cargarMensajes();
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
        }

        async function cargarNegociacion() {
            try {
                const url = `${SCRIPT_URL}?action=get_negociacion&id=${appState.idNegociacion}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
                    appState.negociacion = result.data;
                    document.getElementById('negociacionMonto').textContent = `$${appState.negociacion.Monto.toFixed(2)}`;
                    actualizarEstadoInterfaz(appState.negociacion.Estado);
                    
                    // Iniciar el timer si está activa
                    if (appState.negociacion.Estado.toUpperCase().trim() === 'ACTIVA') {
                         if (!appState.intervaloTimer) {
                            appState.intervaloTimer = setInterval(actualizarTimer, 1000);
                        }
                    } else {
                        document.getElementById('timerDisplay').textContent = '';
                        if (appState.intervaloTimer) clearInterval(appState.intervaloTimer);
                    }
                } else {
                    mostrarNotificacion(`Error al cargar negociación: ${result.message}`, 'danger');
                    deshabilitarChat();
                }
            } catch (error) {
                console.error('Error en cargarNegociacion:', error);
                mostrarNotificacion('Error de conexión con el servidor.', 'danger');
                deshabilitarChat();
            }
        }

        // =========================================================
        // FUNCIÓN CORREGIDA: ACTUALIZA ESTADO E INTERFAZ
        // =========================================================
        function actualizarEstadoInterfaz(estado) {
            const badge = document.getElementById('statusBadge');
            
            // Quitar todas las clases de estado
            badge.classList.remove('status-activa', 'status-completada', 'status-cancelada', 'status-expirada');

            // Asignar la clase y estado
            estado = estado.toUpperCase().trim();
            if (estado === 'ACTIVA') {
                badge.classList.add('status-activa');
                habilitarChat(); // CORRECCIÓN: Habilitar si está activa
            } else if (estado === 'COMPLETADA') {
                badge.classList.add('status-completada');
                deshabilitarChat(); // Deshabilitar si está finalizada
            } else if (estado === 'CANCELADA') {
                badge.classList.add('status-cancelada');
                deshabilitarChat(); // Deshabilitar si está finalizada
            } else if (estado === 'EXPIRADA') {
                badge.classList.add('status-expirada');
                deshabilitarChat(); // Deshabilitar si está finalizada
            } else {
                deshabilitarChat(); // Caso por defecto
            }

            badge.textContent = estado;
        }

        function actualizarTimer() {
            if (!appState.negociacion || appState.negociacion.Estado !== 'ACTIVA') return;

            const fechaExpiracion = new Date(appState.negociacion.Fecha_Expiracion);
            const ahora = new Date();
            const tiempoRestanteMs = fechaExpiracion - ahora;

            if (tiempoRestanteMs <= 0) {
                document.getElementById('timerDisplay').textContent = '00:00:00';
                clearInterval(appState.intervaloTimer);
                // Forzar una recarga para que el estado se actualice a EXPIRADA
                cargarNegociacion(); 
                return;
            }

            const totalSegundos = Math.floor(tiempoRestanteMs / 1000);
            const horas = Math.floor(totalSegundos / 3600);
            const minutos = Math.floor((totalSegundos % 3600) / 60);
            const segundos = totalSegundos % 60;

            const formato = [horas, minutos, segundos]
                .map(n => n.toString().padStart(2, '0'))
                .join(':');

            document.getElementById('timerDisplay').textContent = formato;
        }
        
        async function cargarMensajes() {
            try {
                // LLAMA A LA NUEVA FUNCIÓN DEL SCRIPT
                const url = `${SCRIPT_URL}?action=get_mensajes&id=${appState.idNegociacion}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success && result.data) {
                    renderizarMensajes(result.data);
                } else {
                    console.error('Error al cargar mensajes:', result.message);
                }
            } catch (error) {
                console.error('Error de conexión al cargar mensajes:', error);
            }
        }

        function renderizarMensajes(mensajes) {
            const chatArea = document.getElementById('chatArea');
            // Optimización: si no hay mensajes nuevos, no renderizar
            if (mensajes.length === chatArea.children.length) return; 

            // Limpiar y reconstruir para reflejar el estado actual
            chatArea.innerHTML = ''; 
            
            // Renderizar de abajo hacia arriba (más reciente abajo)
            mensajes.reverse().forEach(msg => {
                const isCliente = msg.Remitente === 'Cliente';
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isCliente ? 'message-cliente' : 'message-creador'}`;
                
                if (msg.Tipo === 'Sistema') {
                    messageDiv.className = 'message message-system';
                }

                messageDiv.innerHTML = `
                    <span>${msg.Mensaje}</span>
                    <span class="message-time">${new Date(msg.Fecha).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
                `;
                
                chatArea.appendChild(messageDiv);
            });
        }
        
        async function enviarMensaje() {
            const input = document.getElementById('messageInput');
            const mensaje = input.value.trim();
            if (!mensaje) return;

            input.disabled = true;
            document.getElementById('sendButton').disabled = true;

            try {
                const url = `${SCRIPT_URL}?action=enviar_mensaje&id=${appState.idNegociacion}&tipoUsuario=${appState.userType}&mensaje=${encodeURIComponent(mensaje)}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    input.value = ''; // Limpiar input
                    cargarMensajes(); // Recargar mensajes para ver el nuevo
                } else {
                    mostrarNotificacion(`Error al enviar: ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                mostrarNotificacion('Error de conexión al enviar mensaje.', 'danger');
            } finally {
                input.disabled = false;
                document.getElementById('sendButton').disabled = input.value.trim() === '';
            }
        }
        
        // =========================================================
        // HANDLERS PARA BOTONES
        // =========================================================
        
        function subirComprobanteHandler() {
            // Alterna la visibilidad de la sección de subida de archivo
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.classList.toggle('hidden');
            // Ocultar controles de cliente mientras se sube
            document.getElementById('clienteControls').classList.add('hidden'); 
            
            // Listener para habilitar/deshabilitar el botón de Subir
            document.getElementById('comprobanteFile').onchange = function() {
                document.getElementById('btnConfirmUpload').disabled = this.files.length === 0;
            };
        }

        async function confirmarSubida() {
            const fileInput = document.getElementById('comprobanteFile');
            if (fileInput.files.length === 0) return;
            
            mostrarNotificacion('Subiendo archivo...', 'warning');
            
            // Aquí iría la lógica real de subida, por ahora solo simulación
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Al finalizar:
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('clienteControls').classList.remove('hidden'); 
            mostrarNotificacion('✅ Comprobante subido (Simulado)');
            
            // Llamar al Apps Script para registrar la subida (usando la acción `subir_comprobante`)
            try {
                const url = `${SCRIPT_URL}?action=subir_comprobante&id=${appState.idNegociacion}`;
                await fetch(url);
                cargarMensajes();
            } catch (e) {
                console.error('Error al registrar comprobante:', e);
            }
        }


        async function verificarPagoHandler() {
            if (!confirm('¿Estás seguro de que deseas verificar el pago y FINALIZAR la negociación?')) return;
            
            mostrarNotificacion('Finalizando negociación...', 'warning');
            try {
                const url = `${SCRIPT_URL}?action=verificar_pago&id=${appState.idNegociacion}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacion('✅ Negociación finalizada con éxito.');
                    cargarNegociacion(); // Recargar para actualizar estado
                } else {
                    mostrarNotificacion(`Error al verificar pago: ${result.message}`, 'danger');
                }
            } catch (error) {
                mostrarNotificacion('Error de conexión al verificar pago.', 'danger');
            }
        }

        async function cancelarNegociacionHandler() {
            if (!confirm('¿Estás seguro de que deseas CANCELAR la negociación? Esta acción es irreversible.')) return;
            
            mostrarNotificacion('Cancelando negociación...', 'warning');
            try {
                const url = `${SCRIPT_URL}?action=cancelar_negociacion&id=${appState.idNegociacion}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacion('❌ Negociación cancelada.');
                    cargarNegociacion(); // Recargar para actualizar estado
                } else {
                    mostrarNotificacion(`Error al cancelar: ${result.message}`, 'danger');
                }
            } catch (error) {
                mostrarNotificacion('Error de conexión al cancelar.', 'danger');
            }
        }
        
        function copiarEnlace(enlace) {
            navigator.clipboard.writeText(enlace).then(() => {
                mostrarNotificacion('✅ Enlace copiado al portapapeles');
            });
            // Método alternativo para compatibilidad
            /*
            const textArea = document.createElement('textarea');
            textArea.value = enlace;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            mostrarNotificacion('✅ Enlace copiado al portapapeles');
            */
        }

        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notificacion = document.createElement('div');
            notificacion.className = `notification notification-${tipo}`;
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                if (document.body.contains(notificacion)) {
                    document.body.removeChild(notificacion);
                }
            }, 3000);
        }

        // Iniciar la aplicación
        document.addEventListener('DOMContentLoaded', init);
        
        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                enviarMensaje();
            }
        });

        document.getElementById('messageInput').addEventListener('input', function(e) {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = this.value.trim() === '' || this.disabled;
        });
    </script>
</body>
</html>
