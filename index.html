<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat TUM - Negociaciones</title>
<style>
body {
font-family: Arial, sans-serif;
max-width: 500px;
margin: 0 auto;
padding: 20px;
background: #f5f5f5;
}
.card {
background: white;
padding: 20px;
border-radius: 10px;
margin-bottom: 20px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
input, textarea, button {
width: 100%;
padding: 10px;
margin: 5px 0;
border: 1px solid #ddd;
border-radius: 5px;
}
button {
background: #007cba;
color: white;
border: none;
cursor: pointer;
}
button:hover { background: #005a87; }
button:disabled { background: #ccc; }
.hidden { display: none; }
.loading { text-align: center; color: #666; padding: 20px; }
.error { background: #fee; color: #c00; padding: 10px; border-radius: 5px; margin: 10px 0; }
.success { background: #efe; color: #060; padding: 10px; border-radius: 5px; margin: 10px 0; }
.messages {
height: 300px;
overflow-y: auto;
border: 1px solid #ddd;
padding: 10px;
margin: 10px 0;
background: #fafafa;
}
.message {
margin: 10px 0;
padding: 10px;
border-radius: 5px;
}
.creador { background: #e3f2fd; margin-left: 20px; }
.cliente { background: #f5f5f5; margin-right: 20px; }
.input-area { display: flex; gap: 10px; }
#messageInput { flex: 1; }
#sendButton { width: auto; }
</style>
</head>
<body>
<div id="createForm" class="card">
<h2>üöÄ Crear Negociaci√≥n TUM</h2>
<div id="debugInfo" class="loading">üîÑ Probando conexi√≥n...</div>
    <input type="email" id="creadorEmail" placeholder="Tu email" value="creador@ejemplo.com">
    <input type="email" id="clienteEmail" placeholder="Email del cliente" value="cliente@ejemplo.com">
    <input type="number" id="monto" placeholder="Monto" value="1000">
    <textarea id="descripcion" placeholder="Descripci√≥n" rows="3">Servicio de consultor√≠a TUM</textarea>

    <button onclick="crearNegociacion()" id="createBtn">Crear Negociaci√≥n</button>
    <div id="formResult"></div>
</div>

<div id="chatInterface" class="card hidden">
    <h2 id="chatTitle">üí¨ Chat</h2>
    <div id="chatInfo" class="loading">Cargando...</div>

    <div class="messages" id="messages">
        <div class="loading">Cargando mensajes...</div>
    </div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." disabled>
        <button onclick="enviarMensaje()" id="sendButton" disabled>Enviar</button>
    </div>
</div>

<script>
    // ‚ö†Ô∏è IMPORTANTE: Usa SOLO esta URL (la que funciona)
    const API_URL = '<https://script.google.com/macros/s/AKfycbxgR_3Yfjzy_FgE6fYi9OIxLiablneUyvWqt5eukezplafrEFdYaw8UL9gaFXQyxn3yEw/exec>';

    let appState = {
        negociacion: null,
        userType: ''
    };

    // Funci√≥n para hacer requests - SIMPLE como tu proyecto
    async function hacerRequest(params) {
        const url = API_URL + '?' + new URLSearchParams(params).toString();

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Error HTTP: ' + response.status);
            }
            return await response.json();
        } catch (error) {
            console.error('Error en request:', error);
            throw error;
        }
    }

    // Inicializar
    async function init() {
        console.log('Iniciando aplicaci√≥n...');

        // Probar conexi√≥n
        try {
            const response = await hacerRequest({action: 'test'});
            const debug = document.getElementById('debugInfo');
            if (response.success) {
                debug.innerHTML = `<div class="success">${response.message}</div>`;
            } else {
                debug.innerHTML = `<div class="error">${response.message}</div>`;
            }
        } catch (error) {
            document.getElementById('debugInfo').innerHTML =
                `<div class="error">Error de conexi√≥n: ${error.message}</div>`;
        }

        // Verificar si estamos en chat
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const userType = urlParams.get('user');

        if (id && userType) {
            appState.userType = userType;
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            cargarChat(id);
        }
    }

    // Crear negociaci√≥n
    async function crearNegociacion() {
        const creador = document.getElementById('creadorEmail').value;
        const cliente = document.getElementById('clienteEmail').value;
        const monto = document.getElementById('monto').value;
        const descripcion = document.getElementById('descripcion').value;

        const btn = document.getElementById('createBtn');
        btn.disabled = true;
        btn.textContent = 'Creando...';

        try {
            const response = await hacerRequest({
                action: 'crear_negociacion',
                creador: creador,
                cliente: cliente,
                monto: monto,
                descripcion: descripcion
            });

            const result = document.getElementById('formResult');

            if (response.success) {
                result.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ ¬°Negociaci√≥n Creada!</h3>
                        <p><strong>ID:</strong> ${response.data.id}</p>
                        <p><a href="${response.data.enlaces.creador}" target="_blank">üëë Abrir como Creador</a></p>
                        <p><a href="${response.data.enlaces.cliente}" target="_blank">üë§ Abrir como Cliente</a></p>
                    </div>
                `;

                // Limpiar formulario
                document.getElementById('creadorEmail').value = '';
                document.getElementById('clienteEmail').value = '';
                document.getElementById('monto').value = '';
                document.getElementById('descripcion').value = '';
            } else {
                result.innerHTML = `<div class="error">‚ùå Error: ${response.message}</div>`;
            }
        } catch (error) {
            document.getElementById('formResult').innerHTML =
                `<div class="error">‚ùå Error de conexi√≥n: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'Crear Negociaci√≥n';
        }
    }

    // Cargar chat
    async function cargarChat(id) {
        try {
            const response = await hacerRequest({
                action: 'get_negociacion',
                id: id
            });

            if (response.success) {
                appState.negociacion = response.data;
                document.getElementById('chatTitle').textContent =
                    appState.userType === 'creador' ? 'üëë Chat - Creador' : 'üë§ Chat - Cliente';
                document.getElementById('chatInfo').textContent =
                    `ID: ${response.data.ID} | $${response.data.Monto} | ${response.data.Estado}`;

                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;

                await cargarMensajes();
                setInterval(cargarMensajes, 2000);
            } else {
                document.getElementById('messages').innerHTML =
                    `<div class="error">‚ùå ${response.message}</div>`;
            }
        } catch (error) {
            document.getElementById('messages').innerHTML =
                `<div class="error">‚ùå Error cargando chat: ${error.message}</div>`;
        }
    }

    // Cargar mensajes
    async function cargarMensajes() {
        if (!appState.negociacion) return;

        try {
            const response = await hacerRequest({
                action: 'get_mensajes',
                id: appState.negociacion.ID
            });

            if (response.success) {
                mostrarMensajes(response.data);
            }
        } catch (error) {
            console.error('Error cargando mensajes:', error);
        }
    }

    // Mostrar mensajes
    function mostrarMensajes(mensajes) {
        const container = document.getElementById('messages');

        if (!mensajes || mensajes.length === 0) {
            container.innerHTML = '<div class="loading">üí¨ No hay mensajes a√∫n</div>';
            return;
        }

        container.innerHTML = mensajes.map(msg => `
            <div class="message ${msg.Remitente.includes('Creador') ? 'creador' : 'cliente'}">
                <strong>${msg.Remitente}</strong><br>
                ${msg.Mensaje}<br>
                <small>${new Date(msg.Fecha).toLocaleString('es-ES')}</small>
            </div>
        `).join('');

        container.scrollTop = container.scrollHeight;
    }

    // Enviar mensaje
    async function enviarMensaje() {
        const input = document.getElementById('messageInput');
        const mensaje = input.value.trim();

        if (!mensaje || !appState.negociacion) return;

        const btn = document.getElementById('sendButton');
        btn.disabled = true;

        try {
            const response = await hacerRequest({
                action: 'enviar_mensaje',
                id: appState.negociacion.ID,
                tipoUsuario: appState.userType,
                mensaje: mensaje
            });

            if (response.success) {
                input.value = '';
                await cargarMensajes();
            } else {
                alert('Error: ' + response.message);
            }
        } catch (error) {
            alert('Error enviando mensaje: ' + error.message);
        } finally {
            btn.disabled = false;
        }
    }

    // Iniciar
    document.addEventListener('DOMContentLoaded', init);
</script>
  </body>
</html>


