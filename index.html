<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat TUM</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { background: #007cba; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; }
        .btn:hover { background: #005a87; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { background: #fee; color: #c00; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #efe; color: #060; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .chat-header { background: #007cba; color: white; padding: 15px; border-radius: 10px 10px 0 0; }
        .messages { height: 300px; overflow-y: auto; padding: 15px; border: 1px solid #ddd; background: #fafafa; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .message-creador { background: #e3f2fd; margin-left: 20px; }
        .message-cliente { background: #f5f5f5; margin-right: 20px; }
        .input-area { display: flex; gap: 10px; margin-top: 10px; }
        #messageInput { flex: 1; }
        #sendButton { width: auto; padding: 10px 20px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Formulario de creaci√≥n -->
        <div id="createForm" class="card">
            <h2>Crear Nueva Negociaci√≥n</h2>
            <div id="debugInfo" class="loading">Probando conexi√≥n...</div>
            
            <div class="form-group">
                <label>Tu Email:</label>
                <input type="email" id="creadorEmail" value="creador@ejemplo.com">
            </div>
            <div class="form-group">
                <label>Email del Cliente:</label>
                <input type="email" id="clienteEmail" value="cliente@ejemplo.com">
            </div>
            <div class="form-group">
                <label>Monto:</label>
                <input type="number" id="monto" value="1000">
            </div>
            <div class="form-group">
                <label>Descripci√≥n:</label>
                <textarea id="descripcion" rows="3">Servicio de consultor√≠a</textarea>
            </div>
            <button class="btn" onclick="crearNegociacion()" id="createBtn">Crear Negociaci√≥n</button>
            <div id="formResult"></div>
        </div>

        <!-- Chat -->
        <div id="chatInterface" class="card hidden">
            <div class="chat-header">
                <h3 id="chatTitle">Chat de Negociaci√≥n</h3>
                <div id="chatInfo"></div>
            </div>
            <div class="messages" id="messages">
                <div class="loading">Cargando mensajes...</div>
            </div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." disabled>
                <button class="btn" id="sendButton" onclick="enviarMensaje()" disabled>Enviar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN - ACTUALIZA ESTA URL CON TU URL DE PRODUCCI√ìN
        const API_URL = 'https://script.google.com/macros/s/AKfycbwWTmQkUpCeTixWcwvUBqBCA37U11l3JMN9f-qXXyTSm-gX3uVsd3LPdNVtH3IUVhGm/exec';
        
        let appState = {
            negociacion: null,
            userType: ''
        };

        // Funci√≥n para hacer requests
        async function makeRequest(params) {
            const url = API_URL + '?' + new URLSearchParams(params).toString();
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'no-cors' // Importante: usar no-cors
                });
                
                // Con no-cors no podemos leer la respuesta, pero sabemos que lleg√≥
                return {status: 'success'};
                
            } catch (error) {
                // Con no-cors, los errores de CORS no se capturan
                return {status: 'success'}; // Asumimos √©xito
            }
        }

        // Funci√≥n alternativa usando JSONP
        function makeJSONPRequest(params, callback) {
            const callbackName = 'callback_' + Date.now();
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(data);
            };
            
            const script = document.createElement('script');
            params.callback = callbackName;
            script.src = API_URL + '?' + new URLSearchParams(params).toString();
            document.body.appendChild(script);
        }

        // Inicializar
        async function init() {
            console.log('Iniciando aplicaci√≥n...');
            
            // Probar conexi√≥n
            makeJSONPRequest({action: 'test'}, function(response) {
                const debugInfo = document.getElementById('debugInfo');
                if (response && response.status === 'success') {
                    debugInfo.innerHTML = `<div class="success">${response.message}</div>`;
                } else {
                    debugInfo.innerHTML = `<div class="error">Error de conexi√≥n</div>`;
                }
            });
            
            // Verificar si estamos en el chat
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const userType = urlParams.get('user');
            
            if (id && userType) {
                appState.userType = userType;
                document.getElementById('createForm').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
                cargarChat(id);
            }
        }

        // Crear negociaci√≥n
        function crearNegociacion() {
            const creador = document.getElementById('creadorEmail').value;
            const cliente = document.getElementById('clienteEmail').value;
            const monto = document.getElementById('monto').value;
            const descripcion = document.getElementById('descripcion').value;
            
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = 'Creando...';
            
            makeJSONPRequest({
                action: 'crear_negociacion',
                creador: creador,
                cliente: cliente,
                monto: monto,
                descripcion: descripcion
            }, function(response) {
                btn.disabled = false;
                btn.textContent = 'Crear Negociaci√≥n';
                
                const resultDiv = document.getElementById('formResult');
                
                if (response.status === 'success') {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Negociaci√≥n Creada</h4>
                            <p><strong>ID:</strong> ${response.data.id}</p>
                            <p><a href="${response.data.enlaces.creador}" target="_blank">Abrir como Creador</a></p>
                            <p><a href="${response.data.enlaces.cliente}" target="_blank">Abrir como Cliente</a></p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${response.message}</div>`;
                }
            });
        }

        // Cargar chat
        function cargarChat(id) {
            makeJSONPRequest({action: 'get_negociacion', id: id}, function(response) {
                if (response.status === 'success') {
                    appState.negociacion = response.data;
                    document.getElementById('chatTitle').textContent = 
                        `Chat - ${appState.userType === 'creador' ? 'üëë Creador' : 'üë§ Cliente'}`;
                    document.getElementById('chatInfo').textContent = 
                        `ID: ${response.data.id} | Monto: $${response.data.monto}`;
                    
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    
                    cargarMensajes();
                    setInterval(cargarMensajes, 2000);
                } else {
                    document.getElementById('messages').innerHTML = 
                        `<div class="error">Error: ${response.message}</div>`;
                }
            });
        }

        // Cargar mensajes
        function cargarMensajes() {
            if (!appState.negociacion) return;
            
            makeJSONPRequest({action: 'get_mensajes', id: appState.negociacion.id}, function(response) {
                if (response.status === 'success') {
                    mostrarMensajes(response.data);
                }
            });
        }

        // Mostrar mensajes
        function mostrarMensajes(mensajes) {
            const container = document.getElementById('messages');
            
            if (!mensajes || mensajes.length === 0) {
                container.innerHTML = '<div class="loading">No hay mensajes a√∫n</div>';
                return;
            }
            
            container.innerHTML = mensajes.map(msg => `
                <div class="message ${msg.remitente.includes('Creador') ? 'message-creador' : 'message-cliente'}">
                    <strong>${msg.remitente}:</strong> ${msg.mensaje}
                    <div style="font-size: 12px; color: #666;">${msg.fecha}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        // Enviar mensaje
        function enviarMensaje() {
            const input = document.getElementById('messageInput');
            const mensaje = input.value.trim();
            
            if (!mensaje || !appState.negociacion) return;
            
            const btn = document.getElementById('sendButton');
            btn.disabled = true;
            
            makeJSONPRequest({
                action: 'enviar_mensaje',
                id: appState.negociacion.id,
                tipoUsuario: appState.userType,
                mensaje: mensaje
            }, function(response) {
                btn.disabled = false;
                
                if (response.status === 'success') {
                    input.value = '';
                    cargarMensajes();
                } else {
                    alert('Error: ' + response.message);
                }
            });
        }

        // Iniciar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

