<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat TUM - Negociaciones</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        input, textarea, button { 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        button { 
            background: #007cba; 
            color: white; 
            border: none; 
            cursor: pointer; 
        }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; }
        .hidden { display: none; }
        .loading { text-align: center; color: #666; padding: 20px; }
        .error { background: #fee; color: #c00; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #efe; color: #060; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .messages { 
            height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 10px 0; 
            background: #fafafa; 
        }
        .message { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .creador { background: #e3f2fd; margin-left: 20px; }
        .cliente { background: #f5f5f5; margin-right: 20px; }
        .input-area { display: flex; gap: 10px; }
        #messageInput { flex: 1; }
        #sendButton { width: auto; }
    </style>
</head>
<body>
    <div id="createForm" class="card">
        <h2>üöÄ Crear Negociaci√≥n TUM</h2>
        <div id="debugInfo" class="loading">üîÑ Probando conexi√≥n...</div>
        
        <input type="email" id="creadorEmail" placeholder="Tu email" value="creador@ejemplo.com">
        <input type="email" id="clienteEmail" placeholder="Email del cliente" value="cliente@ejemplo.com">
        <input type="number" id="monto" placeholder="Monto" value="1000">
        <textarea id="descripcion" placeholder="Descripci√≥n" rows="3">Servicio de consultor√≠a TUM</textarea>
        
        <button onclick="crearNegociacion()" id="createBtn">Crear Negociaci√≥n</button>
        <div id="formResult"></div>
    </div>

    <div id="chatInterface" class="card hidden">
        <h2 id="chatTitle">üí¨ Chat</h2>
        <div id="chatInfo" class="loading">Cargando...</div>
        
        <div class="messages" id="messages">
            <div class="loading">Cargando mensajes...</div>
        </div>
        
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." disabled>
            <button onclick="enviarMensaje()" id="sendButton" disabled>Enviar</button>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è IMPORTANTE: Usa SOLO esta URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwOpWYugaCViMiNJBai9OW4C0NnqUQVo002r5df-g9ZuZGQQfuC9HudgrjbFWLpfw0_YQ/exec';
        
        let appState = { negociacion: null, userType: '' };

        // Funci√≥n para hacer requests (JSONP)
        function hacerRequest(params, callback) {
            const callbackName = 'cb_' + Math.random().toString(36).substr(2, 9);
            window[callbackName] = function(data) {
                delete window[callbackName];
                if (script.parentNode) script.parentNode.removeChild(script);
                callback(data);
            };
            
            const script = document.createElement('script');
            params.callback = callbackName;
            script.src = API_URL + '?' + new URLSearchParams(params).toString();
            document.body.appendChild(script);
        }

        // Inicializar
        function init() {
            console.log('Iniciando app...');
            
            // Probar conexi√≥n
            hacerRequest({action: 'test'}, function(res) {
                const debug = document.getElementById('debugInfo');
                if (res && res.status === 'OK') {
                    debug.innerHTML = `<div class="success">${res.message}</div>`;
                } else {
                    debug.innerHTML = `<div class="error">${res?.message || 'Error de conexi√≥n'}</div>`;
                }
            });
            
            // Verificar si estamos en chat
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const userType = urlParams.get('user');
            
            if (id && userType) {
                appState.userType = userType;
                document.getElementById('createForm').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
                cargarChat(id);
            }
        }

        // Crear negociaci√≥n
        function crearNegociacion() {
            const creador = document.getElementById('creadorEmail').value;
            const cliente = document.getElementById('clienteEmail').value;
            const monto = document.getElementById('monto').value;
            const descripcion = document.getElementById('descripcion').value;
            
            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = 'Creando...';
            
            hacerRequest({
                action: 'crear_negociacion',
                creador: creador,
                cliente: cliente,
                monto: monto,
                descripcion: descripcion
            }, function(res) {
                btn.disabled = false;
                btn.textContent = 'Crear Negociaci√≥n';
                
                const result = document.getElementById('formResult');
                if (res.status === 'OK') {
                    result.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ ¬°Negociaci√≥n Creada!</h3>
                            <p><strong>ID:</strong> ${res.data.id}</p>
                            <p><a href="${res.data.enlaces.creador}" target="_blank">üëë Abrir como Creador</a></p>
                            <p><a href="${res.data.enlaces.cliente}" target="_blank">üë§ Abrir como Cliente</a></p>
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="error">‚ùå Error: ${res.message}</div>`;
                }
            });
        }

        // Cargar chat
        function cargarChat(id) {
            hacerRequest({action: 'get_negociacion', id: id}, function(res) {
                if (res.status === 'OK') {
                    appState.negociacion = res.data;
                    document.getElementById('chatTitle').textContent = 
                        appState.userType === 'creador' ? 'üëë Chat - Creador' : 'üë§ Chat - Cliente';
                    document.getElementById('chatInfo').textContent = 
                        `ID: ${res.data.id} | $${res.data.monto} | ${res.data.estado}`;
                    
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    
                    cargarMensajes();
                    setInterval(cargarMensajes, 2000);
                } else {
                    document.getElementById('messages').innerHTML = 
                        `<div class="error">‚ùå ${res.message}</div>`;
                }
            });
        }

        // Cargar mensajes
        function cargarMensajes() {
            if (!appState.negociacion) return;
            
            hacerRequest({action: 'get_mensajes', id: appState.negociacion.id}, function(res) {
                if (res.status === 'OK') {
                    mostrarMensajes(res.data);
                }
            });
        }

        // Mostrar mensajes
        function mostrarMensajes(mensajes) {
            const container = document.getElementById('messages');
            
            if (!mensajes || mensajes.length === 0) {
                container.innerHTML = '<div class="loading">üí¨ No hay mensajes a√∫n</div>';
                return;
            }
            
            container.innerHTML = mensajes.map(msg => `
                <div class="message ${msg.remitente.includes('Creador') ? 'creador' : 'cliente'}">
                    <strong>${msg.remitente}</strong><br>
                    ${msg.mensaje}<br>
                    <small>${msg.fecha}</small>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        // Enviar mensaje
        function enviarMensaje() {
            const input = document.getElementById('messageInput');
            const mensaje = input.value.trim();
            
            if (!mensaje) return;
            
            const btn = document.getElementById('sendButton');
            btn.disabled = true;
            
            hacerRequest({
                action: 'enviar_mensaje',
                id: appState.negociacion.id,
                tipoUsuario: appState.userType,
                mensaje: mensaje
            }, function(res) {
                btn.disabled = false;
                if (res.status === 'OK') {
                    input.value = '';
                    cargarMensajes();
                } else {
                    alert('Error: ' + res.message);
                }
            });
        }

        // Iniciar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
