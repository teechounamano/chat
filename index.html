<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat TUM - Negociaciones</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px; }
        .header { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 25px; text-align: center; }
        .header.creador { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .user-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-block; margin-top: 10px; }
        .info-panel { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #dee2e6; font-size: 14px; color: #666; }
        .messages { height: 400px; overflow-y: auto; padding: 20px; background: #fafafa; }
        .message { margin-bottom: 15px; padding: 12px 16px; border-radius: 18px; max-width: 80%; word-wrap: break-word; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-creador { background: #2196F3; color: white; margin-left: auto; border-bottom-right-radius: 5px; }
        .message-cliente { background: #e9ecef; color: #333; margin-right: auto; border-bottom-left-radius: 5px; }
        .message-sistema { background: #fff3cd; color: #856404; max-width: 90%; margin: 10px auto; text-align: center; font-size: 13px; }
        .message-sender { font-weight: bold; font-size: 12px; margin-bottom: 5px; opacity: 0.9; }
        .message-time { font-size: 11px; opacity: 0.7; margin-top: 5px; text-align: right; }
        .input-area { padding: 20px; background: white; border-top: 1px solid #dee2e6; display: flex; gap: 12px; align-items: center; }
        #messageInput { flex: 1; padding: 14px 18px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 15px; outline: none; transition: border-color 0.3s; }
        #messageInput:focus { border-color: #4CAF50; }
        #sendButton { background: #4CAF50; color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: background 0.3s; }
        #sendButton:hover { background: #45a049; }
        #sendButton:disabled { background: #ccc; cursor: not-allowed; }
        .loading { text-align: center; padding: 30px; color: #666; font-size: 16px; }
        .error { background: #f8d7da; color: #721c24; padding: 20px; margin: 15px; border-radius: 10px; text-align: center; }
        .success { background: #d4edda; color: #155724; padding: 20px; margin: 15px; border-radius: 10px; text-align: center; }
        .controls { padding: 15px; background: #e3f2fd; border-top: 1px solid #bbdefb; display: flex; gap: 10px; flex-wrap: wrap; }
        .control-btn { padding: 10px 16px; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; flex: 1; min-width: 140px; transition: transform 0.2s; }
        .control-btn:hover { transform: translateY(-2px); }
        .btn-approve { background: #4CAF50; color: white; }
        .btn-reject { background: #f44336; color: white; }
        .btn-upload { background: #FF9800; color: white; }
        .create-form { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus { border-color: #4CAF50; outline: none; }
        .submit-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: transform 0.2s; }
        .submit-btn:hover { transform: translateY(-2px); }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .hidden { display: none; }
        .debug-info { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <div id="createForm" class="create-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: #333;">üöÄ Crear Nueva Negociaci√≥n TUM</h2>
            
            <div class="debug-info" id="debugInfo">
                üîß Conectando con backend...
            </div>
            
            <div class="form-group">
                <label for="creadorEmail">Tu Email (Creador):</label>
                <input type="email" id="creadorEmail" placeholder="tu@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="clienteEmail">Email del Cliente:</label>
                <input type="email" id="clienteEmail" placeholder="cliente@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="monto">Monto ($):</label>
                <input type="number" id="monto" placeholder="1000" required>
            </div>
            
            <div class="form-group">
                <label for="descripcion">Descripci√≥n:</label>
                <textarea id="descripcion" placeholder="Descripci√≥n del trato..." rows="3" required></textarea>
            </div>
            
            <button class="submit-btn" onclick="crearNegociacion()" id="createBtn">Crear Negociaci√≥n</button>
            
            <div id="formResult" style="margin-top: 20px;"></div>
        </div>

        <div id="chatInterface" class="card hidden">
            <div class="header" id="header">
                <h2 id="titulo">üí¨ Chat TUM</h2>
                <div class="user-badge" id="userBadge">Cargando...</div>
            </div>

            <div class="info-panel" id="infoPanel">
                <div id="infoContent">Conectando...</div>
            </div>

            <div class="messages" id="messages">
                <div class="loading">üîÑ Cargando chat...</div>
            </div>

            <div class="controls" id="controls"></div>

            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." autocomplete="off" disabled>
                <button id="sendButton" onclick="enviarMensaje()" disabled>‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        const API_URL = 'https://script.google.com/macros/s/AKfycbx6GtL5Os_q-zRQ18t5Vx_0RBiIfxj75n8oArJFNc_OXaRXnMPmBhkFWLr_xGPqMffuEQ/exec';
        let appState = { negociacion: null, userType: '', mensajes: [], cargando: true };

        // Funci√≥n para hacer requests con JSONP (evita CORS)
        function makeRequest(url, callback) {
            // Crear un callback √∫nico
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(data);
            };

            // Agregar callback a la URL
            const script = document.createElement('script');
            script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
            document.body.appendChild(script);
        }

        // Funci√≥n para hacer POST requests
        async function makePostRequest(action, data) {
            // Para POST, usamos un formulario temporal
            const form = document.createElement('form');
            form.method = 'GET'; // Usamos GET para evitar CORS
            form.action = API_URL;
            
            // Agregar par√°metros
            const params = { action, ...data };
            for (const key in params) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = params[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            
            return new Promise((resolve) => {
                const callbackName = 'post_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    document.body.removeChild(form);
                    resolve(response);
                };
                
                // Agregar callback
                const callbackInput = document.createElement('input');
                callbackInput.type = 'hidden';
                callbackInput.name = 'callback';
                callbackInput.value = callbackName;
                form.appendChild(callbackInput);
                
                // Crear iframe para enviar el formulario
                const iframe = document.createElement('iframe');
                iframe.name = 'post_iframe_' + Math.round(100000 * Math.random());
                iframe.style.display = 'none';
                iframe.onload = function() {
                    // El response se maneja via callback
                };
                
                document.body.appendChild(iframe);
                form.target = iframe.name;
                form.submit();
                
                // Limpiar despu√©s de un tiempo
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                }, 5000);
            });
        }

        // Inicializar la aplicaci√≥n
        async function init() {
            console.log('üöÄ Iniciando aplicaci√≥n TUM...');
            await testBackendConnection();
            
            const urlParams = new URLSearchParams(window.location.search);
            const negociacionId = urlParams.get('id');
            const userType = urlParams.get('user');

            if (negociacionId && userType) {
                appState.userType = userType;
                document.getElementById('createForm').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
                await cargarNegociacion(negociacionId);
            }
        }

        // Probar conexi√≥n con backend
        async function testBackendConnection() {
            try {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.innerHTML = 'üîß Probando conexi√≥n con backend...';
                
                makeRequest(API_URL + '?action=test', function(result) {
                    if (result && result.success) {
                        debugInfo.innerHTML = `‚úÖ Backend conectado: ${result.message}`;
                        console.log('‚úÖ Backend funcionando:', result);
                    } else {
                        debugInfo.innerHTML = `‚ùå Error: ${result.error || 'Respuesta inv√°lida'}`;
                    }
                });
                
            } catch (error) {
                document.getElementById('debugInfo').innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // Crear nueva negociaci√≥n
        async function crearNegociacion() {
            const creadorEmail = document.getElementById('creadorEmail').value;
            const clienteEmail = document.getElementById('clienteEmail').value;
            const monto = document.getElementById('monto').value;
            const descripcion = document.getElementById('descripcion').value;

            if (!creadorEmail || !clienteEmail || !monto || !descripcion) {
                alert('Por favor completa todos los campos');
                return;
            }

            const btn = document.getElementById('createBtn');
            const formResult = document.getElementById('formResult');
            
            btn.disabled = true;
            btn.textContent = 'Creando...';
            formResult.innerHTML = '<div class="loading">üîÑ Creando negociaci√≥n...</div>';

            try {
                makeRequest(
                    API_URL + '?action=crear_negociacion&creador=' + encodeURIComponent(creadorEmail) + 
                    '&cliente=' + encodeURIComponent(clienteEmail) + '&monto=' + monto + 
                    '&descripcion=' + encodeURIComponent(descripcion), 
                    function(result) {
                        if (result.success) {
                            const html = `
                                <div class="success">
                                    <h4>‚úÖ Negociaci√≥n Creada Exitosamente</h4>
                                    <p><strong>ID:</strong> ${result.id}</p>
                                    <p><strong>Enlace Creador:</strong> <a href="${result.enlaces.creador}" target="_blank">Abrir como Creador</a></p>
                                    <p><strong>Enlace Cliente:</strong> <a href="${result.enlaces.cliente}" target="_blank">Abrir como Cliente</a></p>
                                </div>
                            `;
                            formResult.innerHTML = html;
                            
                            // Limpiar formulario
                            document.getElementById('creadorEmail').value = '';
                            document.getElementById('clienteEmail').value = '';
                            document.getElementById('monto').value = '';
                            document.getElementById('descripcion').value = '';
                        } else {
                            formResult.innerHTML = `<div class="error">‚ùå Error: ${result.error}</div>`;
                        }
                        
                        btn.disabled = false;
                        btn.textContent = 'Crear Negociaci√≥n';
                    }
                );
            } catch (error) {
                formResult.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = 'Crear Negociaci√≥n';
            }
        }

        // Cargar negociaci√≥n para el chat
        async function cargarNegociacion(id) {
            makeRequest(API_URL + '?action=get_negociacion&id=' + id + '&user=' + appState.userType, function(data) {
                if (data.error) {
                    mostrarError('No se pudo cargar la negociaci√≥n: ' + data.error);
                    return;
                }

                appState.negociacion = data;
                configurarInterfaz();
                cargarMensajes();
                iniciarAutoRefresh();
            });
        }

        // Configurar interfaz del chat
        function configurarInterfaz() {
            const negociacion = appState.negociacion;
            if (!negociacion) return;

            const header = document.getElementById('header');
            const titulo = document.getElementById('titulo');
            const userBadge = document.getElementById('userBadge');
            const infoContent = document.getElementById('infoContent');
            const controls = document.getElementById('controls');

            if (appState.userType === 'creador') {
                header.classList.add('creador');
                titulo.textContent = 'üëë Chat como Creador';
                userBadge.textContent = 'Creador';
                infoContent.innerHTML = `
                    <strong>ID:</strong> ${negociacion.id} | 
                    <strong>Monto:</strong> $${negociacion.monto} |
                    <strong>Cliente:</strong> ${negociacion.cliente}
                `;
                controls.innerHTML = `
                    <button class="control-btn btn-approve" onclick="verificarPago(true)">‚úÖ Aprobar Pago</button>
                    <button class="control-btn btn-reject" onclick="verificarPago(false)">‚ùå Rechazar</button>
                `;
            } else {
                titulo.textContent = 'üë§ Chat como Cliente';
                userBadge.textContent = 'Cliente';
                infoContent.innerHTML = `
                    <strong>ID:</strong> ${negociacion.id} | 
                    <strong>Monto:</strong> $${negociacion.monto} |
                    <strong>Creador:</strong> ${negociacion.creador}
                `;
                controls.innerHTML = `
                    <button class="control-btn btn-upload" onclick="subirComprobante()">üìé Subir Comprobante</button>
                `;
            }

            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
        }

        // Cargar mensajes
        function cargarMensajes() {
            if (!appState.negociacion) return;

            makeRequest(API_URL + '?action=get_mensajes&id=' + appState.negociacion.id, function(mensajes) {
                if (Array.isArray(mensajes)) {
                    appState.mensajes = mensajes;
                    mostrarMensajes();
                }
            });
        }

        // Mostrar mensajes
        function mostrarMensajes() {
            const contenedor = document.getElementById('messages');
            
            if (appState.mensajes.length === 0) {
                contenedor.innerHTML = '<div class="message-sistema">üí¨ No hay mensajes a√∫n</div>';
                return;
            }

            contenedor.innerHTML = appState.mensajes.map(msg => {
                const esCreador = msg.remitente.includes('Creador');
                return `
                    <div class="message ${esCreador ? 'message-creador' : 'message-cliente'}">
                        <div class="message-sender">${msg.remitente}</div>
                        <div>${msg.mensaje}</div>
                        <div class="message-time">${msg.fecha}</div>
                    </div>
                `;
            }).join('');

            contenedor.scrollTop = contenedor.scrollHeight;
        }

        // Enviar mensaje
        async function enviarMensaje() {
            const input = document.getElementById('messageInput');
            const mensaje = input.value.trim();

            if (!mensaje || !appState.negociacion) return;

            const boton = document.getElementById('sendButton');
            boton.disabled = true;
            boton.textContent = '‚è≥';

            try {
                makeRequest(
                    API_URL + '?action=enviar_mensaje&id=' + appState.negociacion.id + 
                    '&remitente=' + appState.userType + '&tipoUsuario=' + appState.userType + 
                    '&mensaje=' + encodeURIComponent(mensaje),
                    function(result) {
                        if (result.success) {
                            input.value = '';
                            cargarMensajes();
                        } else {
                            alert('Error: ' + result.error);
                        }
                        boton.disabled = false;
                        boton.textContent = '‚û§';
                        input.focus();
                    }
                );
            } catch (error) {
                alert('Error: ' + error.message);
                boton.disabled = false;
                boton.textContent = '‚û§';
            }
        }

        // Funciones de control
        function verificarPago(aprobado) {
            alert(`Pago ${aprobado ? 'aprobado' : 'rechazado'} - Funci√≥n en desarrollo`);
        }

        function subirComprobante() {
            alert('Subir comprobante - Funci√≥n en desarrollo');
        }

        function mostrarError(mensaje) {
            document.getElementById('messages').innerHTML = `<div class="error">‚ùå ${mensaje}</div>`;
        }

        function iniciarAutoRefresh() {
            setInterval(cargarMensajes, 3000);
        }

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') enviarMensaje();
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
